const e="undefined"!=typeof window,t="undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:Function("return this")();function n(e){return"string"==typeof e}function s(e){return"boolean"==typeof e}function i(e){return"function"==typeof e}const r=Array.isArray;function o(e){return"[object Object]"===toString.call(e)}function a(e){return"[object Promise]"===toString.call(e)}function c(e){return i(e)&&0===e.name.indexOf("bound ")&&!e.hasOwnProperty("prototype")}const l=Object.defineProperty,h=Object.defineProperties,u=Object.prototype.hasOwnProperty;function p(e,t=null,...s){t&&n(t);n(e)}function d(e,t=null,...s){t&&n(t);n(e)}function m(e,...t){Promise.resolve().then(e.bind(null,...t))}function f(e){return e.startsWith("//")?`${location.protocol}${e}`:e}function _(e,t=null){if(!n(e)||!e)return"";try{const{origin:t,pathname:n,search:s}=new URL(f(e));if(/\.(\w+)$/.test(n))return`${t}${n}${s}`;const i=`${t}${n}/`.replace(/\/\/$/,"/");return/^https?:\/\//.test(i)?`${i}${s}`:""}catch(s){return p(s,t),""}}function A(e){return n(e)&&e?e.replace(/(^\d+)|([^\w\d-_])/gi,""):""}function b(e){const{origin:t,pathname:n}=new URL(e);if(/\.(\w+)$/.test(n)){const e=`${t}${n}`.split("/");return e.pop(),e.join("/")+"/"}return`${t}${n}/`.replace(/\/\/$/,"/")}function g(e,t){return!e||/^((((ht|f)tps?)|file):)?\/\//.test(e)||/^(data|blob):/.test(e)?e:new URL(e,b(f(t))).toString()}function w(e,t,n,s){let i=0;function r(){++i===e.length&&s&&s()}e.forEach(((e,s)=>{a(e)?e.then((e=>{t({data:e,index:s}),r()})).catch((e=>{n({error:e,index:s}),r()})):(t({data:e,index:s}),r())}))}const y=t.requestIdleCallback||function(e){const t=Date.now();return setTimeout((function(){e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),50)};let E=null;function v(e){E=e}function N(e){E!==e&&(v(e),m((()=>{v(null)})))}function C(){return E}function R(){v(null)}function D(e,t){const n=document.createElement(e,t);return n.__MICRO_APP_NAME__&&delete n.__MICRO_APP_NAME__,n}function M(e,t,n){if(t.innerHTML="",n){const n=e.cloneNode(!0),s=document.createDocumentFragment();Array.from(n.childNodes).forEach((e=>{s.appendChild(e)})),t.appendChild(s)}else Array.from(e.childNodes).forEach((e=>{t.appendChild(e)}))}function P(e){return!e||/(^\d)|([^\w\d-_\u4e00-\u9fa5])/gi.test(e)}function O(e){return/^body$/i.test(e)||/^head$/i.test(e)||/^html$/i.test(e)}function S(e){return function(e){return"undefined"!=typeof ShadowRoot&&e instanceof ShadowRoot}(e)?e.host:e}function I(e){return e?e.replace(/^\s+|\s+$/g,""):""}function U(){return navigator.userAgent.indexOf("Firefox")>-1}var x,L,T,k,W,F,B,$;(L=x||(x={})).NAME="name",L.URL="url",(k=T||(T={})).NOT_LOADED="NOT_LOADED",k.LOADING_SOURCE_CODE="LOADING_SOURCE_CODE",k.LOAD_SOURCE_FINISHED="LOAD_SOURCE_FINISHED",k.LOAD_SOURCE_ERROR="LOAD_SOURCE_ERROR",k.MOUNTING="MOUNTING",k.MOUNTED="MOUNTED",k.UNMOUNT="UNMOUNT",(F=W||(W={})).CREATED="created",F.BEFOREMOUNT="beforemount",F.MOUNTED="mounted",F.UNMOUNT="unmount",F.ERROR="error",F.BEFORESHOW="beforeshow",F.AFTERSHOW="aftershow",F.AFTERHIDDEN="afterhidden",($=B||(B={})).KEEP_ALIVE_SHOW="KEEP_ALIVE_SHOW",$.KEEP_ALIVE_HIDDEN="KEEP_ALIVE_HIDDEN";const H="window,self,globalThis,Array,Object,String,Boolean,Math,Number,Symbol,Date,Promise,Function,Proxy,WeakMap,WeakSet,Set,Map,Reflect,Element,Node,Document,RegExp,Error,TypeError,JSON,isNaN,parseFloat,parseInt,performance,console,decodeURI,encodeURI,decodeURIComponent,encodeURIComponent,location,navigator,undefined";function K(e,t=null,n={}){return i(nt.fetch)?nt.fetch(e,n,t):fetch(e,n).then((e=>e.text()))}class j{static getInstance(){return this.instance||(this.instance=new j),this.instance}
/**
   * run logic of load and format html
   * @param successCb success callback
   * @param errorCb error callback, type: (err: Error, meetFetchErr: boolean) => void
   */run(e,t){const n=e.name,s=e.ssrUrl||e.url;K(s,n,{cache:"no-cache"}).then((i=>{if(!i){const t="html is empty, please check in detail";return e.onerror(new Error(t)),p(t,n)}i=this.formatHTML(s,i,n),t(i,e)})).catch((t=>{p(`Failed to fetch data from ${e.url}, micro-app stop rendering`,n),e.onLoadError(t)}))}formatHTML(e,t,n){return this.processHtml(e,t,n,nt.plugins).replace(/<head[^>]*>[\s\S]*?<\/head>/i,(e=>e.replace(/<head/i,"<micro-app-head").replace(/<\/head>/i,"</micro-app-head>"))).replace(/<body[^>]*>[\s\S]*?<\/body>/i,(e=>e.replace(/<body/i,"<micro-app-body").replace(/<\/body>/i,"</micro-app-body>")))}processHtml(e,t,n,s){var r;if(!s)return t;const a=[];return s.global&&a.push(...s.global),(null===(r=s.modules)||void 0===r?void 0:r[n])&&a.push(...s.modules[n]),a.length>0?a.reduce(((t,n)=>o(n)&&i(n.processHtml)?n.processHtml(t,e,n.options):t),t):t}}const G=/(^|\s+)(html|:root)(?=[\s>~[.#:]+|$)/,V=/(^|\s+)((html[\s>~]+body)|body)(?=[\s>~[.#:]+|$)/;function q(e,t){e=t?`${t} ${e}`:e;const n=new Error(e);throw n.reason=e,t&&(n.filename=t),n}class z{constructor(){this.cssText="",this.prefix="",this.baseURI="",this.linkPath="",this.result="",this.scopecssDisable=!1,this.scopecssDisableSelectors=[],this.scopecssDisableNextLine=!1,this.mediaRule=this.createMatcherForAtRuleWithChildRule(/^@media *([^{]+)/,"media"),this.supportsRule=this.createMatcherForAtRuleWithChildRule(/^@supports *([^{]+)/,"supports"),this.documentRule=this.createMatcherForAtRuleWithChildRule(/^@([-\w]+)?document *([^{]+)/,"document"),this.hostRule=this.createMatcherForAtRuleWithChildRule(/^@host\s*/,"host"),this.importRule=this.createMatcherForNoneBraceAtRule("import"),this.charsetRule=this.createMatcherForNoneBraceAtRule("charset"),this.namespaceRule=this.createMatcherForNoneBraceAtRule("namespace")}exec(e,t,n,s){return this.cssText=e,this.prefix=t,this.baseURI=n,this.linkPath=s||"",this.matchRules(),U()?decodeURIComponent(this.result):this.result}reset(){this.cssText=this.prefix=this.baseURI=this.linkPath=this.result="",this.scopecssDisable=this.scopecssDisableNextLine=!1,this.scopecssDisableSelectors=[]}
// core action for match rules
matchRules(){for(this.matchLeadingSpaces(),this.matchComments();this.cssText.length&&"}"!==this.cssText.charAt(0)&&(this.matchAtRule()||this.matchStyleRule());)this.matchComments()}
// https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleRule
matchStyleRule(){const e=this.formatSelector(!0);return this.scopecssDisableNextLine=!1,e?(this.recordResult(e),this.matchComments(),this.styleDeclarations(),this.matchLeadingSpaces(),!0):q("selector missing",this.linkPath)}formatSelector(e){const t=this.commonMatch(/^([^{]+)/,e);return!!t&&t[0].replace(/(^|,[\n\s]*)([^,]+)/g,((e,t,n)=>(n=I(n),this.scopecssDisableNextLine||this.scopecssDisable&&(!this.scopecssDisableSelectors.length||this.scopecssDisableSelectors.includes(n))||G.test(n)||(n=V.test(n)?n.replace(V,this.prefix+" micro-app-body"):this.prefix+" "+n),t+n)))}
// https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleDeclaration
styleDeclarations(){return this.matchOpenBrace()?(this.matchAllDeclarations(),!!this.matchCloseBrace()||q("Declaration missing '}'",this.linkPath)):q("Declaration missing '{'",this.linkPath)}matchAllDeclarations(){let e=this.commonMatch(/^(?:url\(["']?(?:[^)"'}]+)["']?\)|[^}/])*/,!0)[0];if(e&&(this.scopecssDisableNextLine||this.scopecssDisable&&!this.scopecssDisableSelectors.length||(e=e.replace(/url\(["']?([^)"']+)["']?\)/gm,((e,t)=>/^((data|blob):|#)/.test(t)||/^(https?:)?\/\//.test(t)?e:(/^((\.\.?\/)|[^/])/.test(t)&&this.linkPath&&(this.baseURI=function(e){const t=e.split("/");return t.pop(),f(t.join("/")+"/")}(this.linkPath)),`url("${g(t,this.baseURI)}")`)))),this.recordResult(e)),this.scopecssDisableNextLine=!1,this.cssText&&"}"!==this.cssText.charAt(0))return"/"===this.cssText.charAt(0)&&"*"===this.cssText.charAt(1)?this.matchComments():this.commonMatch(/\/+/),this.matchAllDeclarations()}matchAtRule(){return"@"===this.cssText[0]&&(this.scopecssDisableNextLine=!1,this.keyframesRule()||this.mediaRule()||this.customMediaRule()||this.supportsRule()||this.importRule()||this.charsetRule()||this.namespaceRule()||this.documentRule()||this.pageRule()||this.hostRule()||this.fontFaceRule())}
// https://developer.mozilla.org/en-US/docs/Web/API/CSSKeyframesRule
keyframesRule(){if(!this.commonMatch(/^@([-\w]+)?keyframes\s*/))return!1;if(!this.commonMatch(/^([-\w]+)\s*/))return q("@keyframes missing name",this.linkPath);if(this.matchComments(),!this.matchOpenBrace())return q("@keyframes missing '{'",this.linkPath);for(this.matchComments();this.keyframeRule();)this.matchComments();return this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):q("@keyframes missing '}'",this.linkPath)}keyframeRule(){let e;const t=[];for(;e=this.commonMatch(/^((\d+\.\d+|\.\d+|\d+)%?|[a-z]+)\s*/);)t.push(e[1]),this.commonMatch(/^,\s*/);return!!t.length&&(this.styleDeclarations(),this.matchLeadingSpaces(),!0)}
// https://github.com/postcss/postcss-custom-media
customMediaRule(){return!!this.commonMatch(/^@custom-media\s+(--[^\s]+)\s*([^{;]+);/)&&(this.matchLeadingSpaces(),!0)}
// https://developer.mozilla.org/en-US/docs/Web/API/CSSPageRule
pageRule(){return!!this.commonMatch(/^@page */)&&(this.formatSelector(!1),this.scopecssDisableNextLine=!1,this.commonHandlerForAtRuleWithSelfRule("page"))}
// https://developer.mozilla.org/en-US/docs/Web/API/CSSFontFaceRule
fontFaceRule(){return!!this.commonMatch(/^@font-face\s*/)&&this.commonHandlerForAtRuleWithSelfRule("font-face")}
// common matcher for @media, @supports, @document, @host
createMatcherForAtRuleWithChildRule(e,t){return()=>!!this.commonMatch(e)&&(this.matchOpenBrace()?(this.matchComments(),this.matchRules(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):q(`@${t} missing '}'`,this.linkPath)):q(`@${t} missing '{'`,this.linkPath))}
// common matcher for @import, @charset, @namespace
createMatcherForNoneBraceAtRule(e){const t=new RegExp("^@"+e+"\\s*([^;]+);");return()=>!!this.commonMatch(t)&&(this.matchLeadingSpaces(),!0)}
// common handler for @font-face, @page
commonHandlerForAtRuleWithSelfRule(e){return this.matchOpenBrace()?(this.matchAllDeclarations(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):q(`@${e} missing '}'`,this.linkPath)):q(`@${e} missing '{'`,this.linkPath)}
// match and slice comments
matchComments(){for(;this.matchComment(););}
// css comment
matchComment(){if("/"!==this.cssText.charAt(0)||"*"!==this.cssText.charAt(1))return!1;this.scopecssDisableNextLine=!1;let e=2;for(;""!==this.cssText.charAt(e)&&("*"!==this.cssText.charAt(e)||"/"!==this.cssText.charAt(e+1));)++e;if(e+=2,""===this.cssText.charAt(e-1))return q("End of comment missing",this.linkPath);let t=this.cssText.slice(2,e-2);if(this.recordResult(`/*${t}*/`),t=I(t.replace(/^\s*!/,"")),"scopecss-disable-next-line"===t)this.scopecssDisableNextLine=!0;else if(/^scopecss-disable/.test(t))if("scopecss-disable"===t)this.scopecssDisable=!0;else{this.scopecssDisable=!0;t.replace("scopecss-disable","").split(",").forEach((e=>{this.scopecssDisableSelectors.push(I(e))}))}else"scopecss-enable"===t&&(this.scopecssDisable=!1,this.scopecssDisableSelectors=[]);return this.cssText=this.cssText.slice(e),this.matchLeadingSpaces(),!0}commonMatch(e,t=!1){const n=e.exec(this.cssText);if(!n)return;const s=n[0];return this.cssText=this.cssText.slice(s.length),t||this.recordResult(s),n}matchOpenBrace(){return this.commonMatch(/^{\s*/)}matchCloseBrace(){return this.commonMatch(/^}/)}
// match and slice the leading spaces
matchLeadingSpaces(){this.commonMatch(/^\s*/)}
// splice string
recordResult(e){U()?this.result+=encodeURIComponent(e):this.result+=e}}function Q(e,t,n,s,i){if(!e.__MICRO_APP_HAS_SCOPED__){e.__MICRO_APP_HAS_SCOPED__=!0;let o=null;try{o=J.exec(e.textContent,n,s,i),J.reset()}catch(r){J.reset(),p("An error occurred while parsing CSS:\n",t)}o&&(e.textContent=o)}}let J;function X(e,t){if(t.scopecss){const n=`${nt.tagName}[name=${t.name}]`;if(J||(J=new z),e.textContent)Q(e,t.name,n,t.url,e.__MICRO_APP_LINK_PATH__);else{const s=new MutationObserver((function(){s.disconnect(),e.textContent&&!e.hasAttribute("data-styled")&&Q(e,t.name,n,t.url,e.__MICRO_APP_LINK_PATH__)}));s.observe(e,{childList:!0})}}return e}function Y(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},srcElement:{get:()=>t},target:{get:()=>t}})}function Z(e){const t=new CustomEvent("load");Y(t,e),i(e.onload)?e.onload(t):e.dispatchEvent(t)}function ee(e){const t=new CustomEvent("error");Y(t,e),i(e.onerror)?e.onerror(t):e.dispatchEvent(t)}const te=new Map;function ne(e,t,n,s=!1){const i=e.getAttribute("rel");let r=e.getAttribute("href"),o=null;if("stylesheet"===i&&r){if(r=g(r,n.url),s)return{url:r,info:{code:"",isGlobal:e.hasAttribute("global")}};o=document.createComment(`link element with href=${r} move to micro-app-head as style element`),n.source.links.set(r,{code:"",placeholder:o,isGlobal:e.hasAttribute("global")})}else i&&["prefetch","preload","prerender","icon","apple-touch-icon"].includes(i)?s?o=document.createComment(`link element with rel=${i}${r?" & href="+r:""} removed by micro-app`):t.removeChild(e):r&&e.setAttribute("href",g(r,n.url));return s?{replaceComment:o}:o?t.replaceChild(o,e):void 0}function se(e,t,n){const s=Array.from(t.source.links.entries());w(s.map((([e])=>te.has(e)?te.get(e):K(e,t.name))),(e=>{!function(e,t,n,s,i){t.isGlobal&&!te.has(e)&&te.set(e,n);const r=D("style");r.textContent=n,r.__MICRO_APP_LINK_PATH__=e,r.setAttribute("data-origin-href",e),t.placeholder.parentNode?t.placeholder.parentNode.replaceChild(X(r,i),t.placeholder):s.appendChild(X(r,i));t.placeholder=null,t.code=n}(s[e.index][0],s[e.index][1],e.data,n,t)}),(e=>{p(e,t.name)}),(()=>{t.onLoad(e)}))}const ie=new WeakMap;function re(e,t,n){if(t instanceof HTMLStyleElement){if(t.hasAttribute("exclude")){const e=document.createComment("style element with exclude attribute ignored by micro-app");return ie.set(t,e),e}return n.scopecss&&!t.hasAttribute("ignore")?X(t,n):t}if(t instanceof HTMLLinkElement){if(t.hasAttribute("exclude")||ve(t.getAttribute("href"),n.name)){const e=document.createComment("link element with exclude attribute ignored by micro-app");return ie.set(t,e),e}if(t.hasAttribute("ignore")||Ne(t.getAttribute("href"),n.name)||t.href&&i(nt.excludeAssetFilter)&&nt.excludeAssetFilter(t.href))return t;const{url:s,info:r,replaceComment:o}=ne(t,e,n,!0);if(s&&r){const e=D("style");return e.__MICRO_APP_LINK_PATH__=s,function(e,t,n,s,i){if(n.source.links.has(e))return i.textContent=n.source.links.get(e).code,X(i,n),void m((()=>Z(s)));if(te.has(e)){const r=te.get(e);return t.code=r,n.source.links.set(e,t),i.textContent=r,X(i,n),void m((()=>Z(s)))}K(e,n.name).then((r=>{t.code=r,n.source.links.set(e,t),t.isGlobal&&te.set(e,r),i.textContent=r,X(i,n),Z(s)})).catch((e=>{p(e,n.name),ee(s)}))}(s,r,n,t,e),ie.set(t,e),e}return o?(ie.set(t,o),o):t}if(t instanceof HTMLScriptElement){if(t.src&&i(nt.excludeAssetFilter)&&nt.excludeAssetFilter(t.src))return t;const{replaceComment:s,url:r,info:o}=ye(t,e,n,!0)||{};if(r&&o){if(o.isExternal){const e=function(e,t,n,s){const i=()=>Z(s);if(n.source.scripts.has(e)){const t=n.source.scripts.get(e);return!t.module&&m(i),Re(e,n,t,!0,i)}if(we.has(e)){const s=we.get(e);return t.code=s,n.source.scripts.set(e,t),!t.module&&m(i),Re(e,n,t,!0,i)}let r;r=n.inline||t.module?D("script"):document.createComment(`dynamic script with src='${e}' extract by micro-app`);return K(e,n.name).then((o=>{t.code=o,n.source.scripts.set(e,t),t.isGlobal&&we.set(e,o);try{o=Pe(e,n,o,t),n.inline||t.module?De(e,o,t.module,r,i):Me(o,t)}catch(a){}!t.module&&Z(s)})).catch((e=>{p(e,n.name),ee(s)})),r}(r,o,n,t);return ie.set(t,e),e}{const e=Re(r,n,o,!0);return ie.set(t,e),e}}return s?(ie.set(t,s),s):t}return t}function oe(e,t,n,s,i){const r=function(e,t){var n,s;if(e===document.head)return null===(n=null==t?void 0:t.container)||void 0===n?void 0:n.querySelector("micro-app-head");if(e===document.body)return null===(s=null==t?void 0:t.container)||void 0===s?void 0:s.querySelector("micro-app-body");return null}(n,e);return r?i&&!r.contains(i)?be.rawAppendChild.call(r,s):t!==be.rawRemoveChild||r.contains(s)?ae(t,r,s,i):n.contains(s)?t.call(n,s):s:ae(t,n,s,i)}function ae(e,t,n,s){return(i=e)===be.rawAppend||i===be.rawPrepend?e.call(t,n):e.call(t,n,s);var i}function ce(e){var t;return null!==(t=ie.get(e))&&void 0!==t?t:e}function le(e,t,n,s){if(null==t?void 0:t.__MICRO_APP_NAME__){const i=Xe.get(t.__MICRO_APP_NAME__);return(null==i?void 0:i.container)?oe(i,s,e,re(e,t,i),n&&ce(n)):s===be.rawAppend||s===be.rawPrepend?s.call(e,t):s.call(e,t,n)}if(s===be.rawAppend||s===be.rawPrepend){const n=C();if(!(t instanceof Node)&&n){const i=Xe.get(n);if(null==i?void 0:i.container){if(e===document.head)return s.call(i.container.querySelector("micro-app-head"),t);if(e===document.body)return s.call(i.container.querySelector("micro-app-body"),t)}}return s.call(e,t)}return s.call(e,t,n)}function he(){!function(){const e=be.rawDocument;function t(t){var n,s,i;const r=C();return r&&t&&!O(t)&&// see https://github.com/micro-zoe/micro-app/issues/56
e===this?null!==(i=null===(s=null===(n=Xe.get(r))||void 0===n?void 0:n.container)||void 0===s?void 0:s.querySelector(t))&&void 0!==i?i:null:be.rawQuerySelector.call(this,t)}function n(t){var n,s,i;const r=C();return r&&t&&!O(t)&&e===this?null!==(i=null===(s=null===(n=Xe.get(r))||void 0===n?void 0:n.container)||void 0===s?void 0:s.querySelectorAll(t))&&void 0!==i?i:[]:be.rawQuerySelectorAll.call(this,t)}Document.prototype.createElement=function(e,t){return ue(be.rawCreateElement.call(this,e,t))},Document.prototype.createElementNS=function(e,t,n){return ue(be.rawCreateElementNS.call(this,e,t,n))},Document.prototype.createDocumentFragment=function(){return ue(be.rawCreateDocumentFragment.call(this))},Document.prototype.querySelector=t,Document.prototype.querySelectorAll=n,Document.prototype.getElementById=function(e){if(!C()||P(e))return be.rawGetElementById.call(this,e);try{return t.call(this,`#${e}`)}catch(n){return be.rawGetElementById.call(this,e)}},Document.prototype.getElementsByClassName=function(e){if(!C()||P(e))return be.rawGetElementsByClassName.call(this,e);try{return n.call(this,`.${e}`)}catch(t){return be.rawGetElementsByClassName.call(this,e)}},Document.prototype.getElementsByTagName=function(e){var t;const s=C();if(!s||O(e)||P(e)||!(null===(t=Xe.get(s))||void 0===t?void 0:t.inline)&&/^script$/i.test(e))return be.rawGetElementsByTagName.call(this,e);try{return n.call(this,e)}catch(i){return be.rawGetElementsByTagName.call(this,e)}},Document.prototype.getElementsByName=function(e){if(!C()||P(e))return be.rawGetElementsByName.call(this,e);try{return n.call(this,`[name=${e}]`)}catch(t){return be.rawGetElementsByName.call(this,e)}}}(),Element.prototype.appendChild=function(e){return le(this,e,null,be.rawAppendChild)},Element.prototype.insertBefore=function(e,t){return le(this,e,t,be.rawInsertBefore)},Element.prototype.replaceChild=function(e,t){return le(this,e,t,be.rawReplaceChild)},Element.prototype.append=function(...e){let t=0;const n=e.length;for(;t<n;)le(this,e[t],null,be.rawAppend),t++},Element.prototype.prepend=function(...e){let t=e.length;for(;t>0;)le(this,e[t-1],null,be.rawPrepend),t--},Element.prototype.removeChild=function(e){if(null==e?void 0:e.__MICRO_APP_NAME__){const t=Xe.get(e.__MICRO_APP_NAME__);return(null==t?void 0:t.container)?oe(t,be.rawRemoveChild,this,ce(e)):be.rawRemoveChild.call(this,e)}return be.rawRemoveChild.call(this,e)},Element.prototype.cloneNode=function(e){const t=be.rawCloneNode.call(this,e);return this.__MICRO_APP_NAME__&&(t.__MICRO_APP_NAME__=this.__MICRO_APP_NAME__),t}}function ue(e){const t=C();return t&&(e.__MICRO_APP_NAME__=t),e}let pe=!1;function de(){v(null),Document.prototype.createElement=be.rawCreateElement,Document.prototype.createElementNS=be.rawCreateElementNS,Document.prototype.createDocumentFragment=be.rawCreateDocumentFragment,Document.prototype.querySelector=be.rawQuerySelector,Document.prototype.querySelectorAll=be.rawQuerySelectorAll,Document.prototype.getElementById=be.rawGetElementById,Document.prototype.getElementsByClassName=be.rawGetElementsByClassName,Document.prototype.getElementsByTagName=be.rawGetElementsByTagName,Document.prototype.getElementsByName=be.rawGetElementsByName,Element.prototype.appendChild=be.rawAppendChild,Element.prototype.insertBefore=be.rawInsertBefore,Element.prototype.replaceChild=be.rawReplaceChild,Element.prototype.removeChild=be.rawRemoveChild,Element.prototype.append=be.rawAppend,Element.prototype.prepend=be.rawPrepend,Element.prototype.cloneNode=be.rawCloneNode}let me=!1;class fe{constructor(){this.appInstanceMap=Xe}static getInstance(){return this.instance||(this.instance=new fe),this.instance}get(e){return this.appInstanceMap.get(e)}set(e,t){this.appInstanceMap.set(e,t)}getAll(){return Array.from(this.appInstanceMap.values())}clear(){this.appInstanceMap.clear()}}function _e(){Ae(),fe.getInstance().getAll().forEach((e=>{e.container&&S(e.container).disconnectedCallback()})),!window.__MICRO_APP_UMD_MODE__&&fe.getInstance().clear()}function Ae(){window.__MICRO_APP_ENVIRONMENT__&&window.removeEventListener("unmount",_e,!1)}const be={};function ge(){if(e){const e=Element.prototype.setAttribute,t=Element.prototype.appendChild,n=Element.prototype.insertBefore,s=Element.prototype.replaceChild,i=Element.prototype.removeChild,r=Element.prototype.append,o=Element.prototype.prepend,a=Element.prototype.cloneNode,c=Document.prototype.createElement,l=Document.prototype.createElementNS,h=Document.prototype.createDocumentFragment,u=Document.prototype.querySelector,p=Document.prototype.querySelectorAll,d=Document.prototype.getElementById,m=Document.prototype.getElementsByClassName,f=Document.prototype.getElementsByTagName,_=Document.prototype.getElementsByName,A=new Proxy(Image,{construct(e,t){const n=new e(...t);return n.__MICRO_APP_NAME__=C(),n}}),b=Function("return window")(),g=Function("return document")(),w="noModule"in document.createElement("script"),y=b.addEventListener,E=b.removeEventListener,v=b.setInterval,N=b.setTimeout,R=b.clearInterval,M=b.clearTimeout,P=g.addEventListener,O=g.removeEventListener;window.__MICRO_APP_BASE_APPLICATION__=!0,Object.assign(be,{
// source/patch
rawSetAttribute:e,rawAppendChild:t,rawInsertBefore:n,rawReplaceChild:s,rawRemoveChild:i,rawAppend:r,rawPrepend:o,rawCloneNode:a,
// rawGetBoundingClientRect,
rawCreateElement:c,rawCreateElementNS:l,rawCreateDocumentFragment:h,rawQuerySelector:u,rawQuerySelectorAll:p,rawGetElementById:d,rawGetElementsByClassName:m,rawGetElementsByTagName:f,rawGetElementsByName:_,ImageProxy:A,
// common global vars
rawWindow:b,rawDocument:g,supportModuleScript:w,
// sandbox/effect
rawWindowAddEventListener:y,rawWindowRemoveEventListener:E,rawSetInterval:v,rawSetTimeout:N,rawClearInterval:R,rawClearTimeout:M,rawDocumentAddEventListener:P,rawDocumentRemoveEventListener:O}),function(){if(!me){me=!0;const e=D("style");be.rawSetAttribute.call(e,"type","text/css"),e.textContent=`\n${nt.tagName}, micro-app-body { display: block; } \nmicro-app-head { display: none; }`,be.rawDocument.head.appendChild(e)}}(),Ae(),window.__MICRO_APP_ENVIRONMENT__&&window.addEventListener("unmount",_e,!1)}}const we=new Map;function ye(e,t,n,s=!1){let i=null,r=e.getAttribute("src");if(r&&(r=g(r,n.url)),e.hasAttribute("exclude")||ve(r,n.name))i=document.createComment("script element with exclude attribute removed by micro-app");else{if(e.type&&!["text/javascript","text/ecmascript","application/javascript","application/ecmascript","module","systemjs-module","systemjs-importmap"].includes(e.type)||e.hasAttribute("ignore")||Ne(r,n.name))return null;if(be.supportModuleScript&&e.noModule||!be.supportModuleScript&&"module"===e.type)i=document.createComment((e.noModule?"noModule":"module")+" script ignored by micro-app");else if(r){const t={code:"",isExternal:!0,isDynamic:s,async:e.hasAttribute("async"),defer:e.defer||"module"===e.type,module:"module"===e.type,isGlobal:e.hasAttribute("global")};if(s)return{url:r,info:t};n.source.scripts.set(r,t),i=document.createComment(`script with src='${r}' extract by micro-app`)}else if(e.textContent){const t="inline-"+Math.random().toString(36).substr(2,15),r={code:e.textContent,isExternal:!1,isDynamic:s,async:!1,defer:"module"===e.type,module:"module"===e.type};if(s)return{url:t,info:r};n.source.scripts.set(t,r),i=document.createComment("inline script extract by micro-app")}else s||(i=document.createComment("script element removed by micro-app"))}return s?{replaceComment:i}:t.replaceChild(i,e)}function Ee(e){var t,n,s;return[...(null===(t=nt.plugins)||void 0===t?void 0:t.global)||[],...(null===(s=null===(n=nt.plugins)||void 0===n?void 0:n.modules)||void 0===s?void 0:s[e])||[]]}function ve(e,t){if(!e)return!1;return(Ee(t)||[]).some((t=>!!t.excludeChecker&&t.excludeChecker(e)))}function Ne(e,t){if(!e)return!1;return(Ee(t)||[]).some((t=>!!t.ignoreChecker&&t.ignoreChecker(e)))}function Ce(e,t){const n=Array.from(t.source.scripts.entries()),s=[],i=[];for(const[r,o]of n)if(o.isExternal){const e=we.get(r);e?o.code=e:(!o.defer&&!o.async||t.isPrefetch)&&(s.push(K(r,t.name)),i.push([r,o]))}s.length?w(s,(e=>{!function(e,t,n){t.isGlobal&&!we.has(e)&&we.set(e,n);t.code=n}(i[e.index][0],i[e.index][1],e.data)}),(e=>{p(e,t.name)}),(()=>{t.onLoad(e)})):t.onLoad(e)}function Re(e,t,n,s,i){var r;try{const o=Pe(e,t,n.code,n);if(t.inline||n.module){const a=D("script");if(De(e,o,n.module,a,i),s)return a;null===(r=t.container)||void 0===r||r.querySelector("micro-app-body").appendChild(a)}else if(Me(o,n),s)return document.createComment("dynamic script extract by micro-app")}catch(o){}}function De(e,t,n,s,i){if(n){const e=new Blob([t],{type:"text/javascript"});s.src=URL.createObjectURL(e),s.setAttribute("type","module"),i&&(i.moduleCount&&i.moduleCount--,s.onload=i.bind(s,0===i.moduleCount))}else s.textContent=t;e.startsWith("inline-")||s.setAttribute("data-origin-src",e)}function Me(e,t){t.code2Function||(t.code2Function=new Function(e)),t.code2Function.call(window)}function Pe(e,t,n,s){return o(nt.plugins)&&(n=function(e,t,n,s,i){var r;const o=Oe(s.global,t,e,i);return Oe(null===(r=s.modules)||void 0===r?void 0:r[n],o,e,i)}(e,n,t.name,nt.plugins,s)),t.sandBox&&!s.module?(be.rawWindow.__MICRO_APP_PROXY_WINDOW__=t.sandBox.proxyWindow,`;(function(proxyWindow){with(proxyWindow.__MICRO_APP_WINDOW__){(function(${H}){;${n}\n}).call(proxyWindow,${H})}})(window.__MICRO_APP_PROXY_WINDOW__);`):n}function Oe(e,t,n,s){return r(e)?e.reduce(((e,t)=>o(t)&&i(t.loader)?t.loader(e,n,t.options,s):e),t):t}function Se(e,t,n){const s=Array.from(e.children);s.length&&s.forEach((e=>{Se(e,t)}));for(const i of s)i instanceof HTMLLinkElement?i.hasAttribute("exclude")||ve(i.getAttribute("href"),t.name)?e.replaceChild(document.createComment("link element with exclude attribute ignored by micro-app"),i):i.hasAttribute("ignore")||Ne(i.getAttribute("href"),t.name)?i.hasAttribute("href")&&i.setAttribute("href",g(i.getAttribute("href"),t.url)):ne(i,e,t):i instanceof HTMLStyleElement?i.hasAttribute("exclude")?e.replaceChild(document.createComment("style element with exclude attribute ignored by micro-app"),i):t.scopecss&&!i.hasAttribute("ignore")&&X(i,t):i instanceof HTMLScriptElement?ye(i,e,t):i instanceof HTMLMetaElement||i instanceof HTMLTitleElement?e.removeChild(i):i instanceof HTMLImageElement&&i.hasAttribute("src")&&i.setAttribute("src",g(i.getAttribute("src"),t.url))}function Ie(e,t){const n=function(e){const t=D("div");return t.innerHTML=e,t}(e),s=n.querySelector("micro-app-head"),i=n.querySelector("micro-app-body");if(!s||!i){const e=`element ${s?"body":"head"} is missing`;return t.onerror(new Error(e)),p(e,t.name)}Se(n,t),t.source.links.size?se(n,t,s):t.onLoad(n),t.source.scripts.size?Ce(n,t):t.onLoad(n)}const Ue=new class{constructor(){this.eventList=new Map}
// whether the name is legal
isLegalName(e){return!!e||(p("event-center: Invalid name"),!1)}
/**
   * add listener
   * @param name event name
   * @param f listener
   * @param autoTrigger If there is cached data when first bind listener, whether it needs to trigger, default is false
   */on(e,t,n=!1){if(this.isLegalName(e)){if(!i(t))return p("event-center: Invalid callback function");let s=this.eventList.get(e);s?n&&Object.getOwnPropertyNames(s.data).length&&t(s.data):(s={data:{},callbacks:new Set},this.eventList.set(e,s)),s.callbacks.add(t)}}
// remove listener, but the data is not cleared
off(e,t){if(this.isLegalName(e)){const n=this.eventList.get(e);n&&(i(t)?n.callbacks.delete(t):n.callbacks.clear())}}
// dispatch data
dispatch(e,t){if(this.isLegalName(e)){if(!o(t))return p("event-center: data must be object");let n=this.eventList.get(e);if(n){if(n.data!==t){n.data=t;for(const e of n.callbacks)e(t)}}else n={data:t,callbacks:new Set},this.eventList.set(e,n)}}
// get data
getData(e){var t;const n=this.eventList.get(e);return null!==(t=null==n?void 0:n.data)&&void 0!==t?t:null}};function xe(e,t){return n(e)&&e?t?`__from_base_app_${e}__`:`__from_micro_app_${e}__`:""}class Le{
/**
   * add listener of global data
   * @param cb listener
   * @param autoTrigger If there is cached data when first bind listener, whether it needs to trigger, default is false
   */
addGlobalDataListener(e,t){const n=this.appName;n&&(e.__APP_NAME__=n,e.__AUTO_TRIGGER__=t),Ue.on("global",e,t)}
/**
   * remove listener of global data
   * @param cb listener
   */removeGlobalDataListener(e){i(e)&&Ue.off("global",e)}
/**
   * dispatch global data
   * @param data data
   */setGlobalData(e){R(),Ue.dispatch("global",e)}
/**
   * get global data
   */getGlobalData(){return Ue.getData("global")}
/**
   * clear all listener of global data
   * if appName exists, only the specified functions is cleared
   * if appName not exists, only clear the base app functions
   */clearGlobalDataListener(){const e=this.appName,t=Ue.eventList.get("global");if(t)for(const n of t.callbacks)(e&&e===n.__APP_NAME__||!e&&!n.__APP_NAME__)&&t.callbacks.delete(n)}}class Te extends Le{
/**
   * add listener
   * @param appName app.name
   * @param cb listener
   * @param autoTrigger If there is cached data when first bind listener, whether it needs to trigger, default is false
   */
addDataListener(e,t,n){Ue.on(xe(A(e),!1),t,n)}
/**
   * remove listener
   * @param appName app.name
   * @param cb listener
   */removeDataListener(e,t){i(t)&&Ue.off(xe(A(e),!1),t)}
/**
   * get data from micro app or base app
   * @param appName app.name
   * @param fromBaseApp whether get data from base app, default is false
   */getData(e,t=!1){return Ue.getData(xe(A(e),t))}
/**
   * Dispatch data to the specified micro app
   * @param appName app.name
   * @param data data
   */setData(e,t){Ue.dispatch(xe(A(e),!0),t)}
/**
   * clear all listener for specified micro app
   * @param appName app.name
   */clearDataListener(e){Ue.off(xe(A(e),!1))}}class ke extends Le{constructor(e){super(),this.appName=A(e),!this.appName&&p(`Invalid appName ${e}`)}
/**
   * add listener, monitor the data sent by the base app
   * @param cb listener
   * @param autoTrigger If there is cached data when first bind listener, whether it needs to trigger, default is false
   */addDataListener(e,t){e.__AUTO_TRIGGER__=t,Ue.on(xe(this.appName,!0),e,t)}
/**
   * remove listener
   * @param cb listener
   */removeDataListener(e){i(e)&&Ue.off(xe(this.appName,!0),e)}
/**
   * get data from base app
   */getData(){return Ue.getData(xe(this.appName,!0))}
/**
   * dispatch data to base app
   * @param data data
   */dispatch(e){R(),Ue.dispatch(xe(this.appName,!1),e);const t=Xe.get(this.appName);if((null==t?void 0:t.container)&&o(e)){const n=new CustomEvent("datachange",{detail:{data:e}});S(t.container).dispatchEvent(n)}}
/**
   * clear all listeners
   */clearDataListener(){Ue.off(xe(this.appName,!0))}}function We(e,t){if(t.__MICRO_APP_BOUND_WINDOW_FUNCTION__)return t.__MICRO_APP_BOUND_WINDOW_FUNCTION__;if(!function(e){var t;if(s(e.__MICRO_APP_IS_CONSTRUCTOR__))return e.__MICRO_APP_IS_CONSTRUCTOR__;const n=e.toString(),i=(null===(t=e.prototype)||void 0===t?void 0:t.constructor)===e&&Object.getOwnPropertyNames(e.prototype).length>1||/^function\s+[A-Z]/.test(n)||/^class\s+/.test(n);return e.__MICRO_APP_IS_CONSTRUCTOR__=i}(t)&&!function(e){return s(e.__MICRO_APP_IS_BOUND_FUNCTION__)?e.__MICRO_APP_IS_BOUND_FUNCTION__:e.__MICRO_APP_IS_BOUND_FUNCTION__=c(e)}(t)){const n=t.bind(e);for(const e in t)n[e]=t[e];return t.hasOwnProperty("prototype")&&l(n,"prototype",{value:t.prototype,configurable:!0,enumerable:!1,writable:!0}),t.__MICRO_APP_BOUND_WINDOW_FUNCTION__=n}return t}const Fe=new Map;let Be=!1;const $e=new Map;function He(){const{rawDocument:e,rawDocumentAddEventListener:t,rawDocumentRemoveEventListener:n}=be;!Be&&function(){if(Be=!0,Object.getOwnPropertyDescriptor(document,"onclick"))return d("Cannot redefine document property onclick");const e=document.onclick;document.onclick=null;let t=!1;function n(e){Fe.forEach((t=>{i(t)&&t.call(document,e)}))}l(document,"onclick",{configurable:!0,enumerable:!0,get(){const e=C();return e?Fe.get(e):Fe.get("base")},set(e){const s=C();s?Fe.set(s,e):Fe.set("base",e),!t&&i(e)&&(t=!0,be.rawDocumentAddEventListener.call(be.rawDocument,"click",n,!1))}}),e&&(document.onclick=e)}(),document.addEventListener=function(n,s,i){var r;const o=C();if(o&&(!(null===(r=Xe.get(o))||void 0===r?void 0:r.umdMode)||!c(s))){const e=$e.get(o);if(e){const t=e.get(n);t?t.add(s):e.set(n,new Set([s]))}else $e.set(o,new Map([[n,new Set([s])]]));s&&(s.__MICRO_APP_MARK_OPTIONS__=i)}t.call(e,n,s,i)},document.removeEventListener=function(t,s,i){var r;const o=C();if(o&&(!(null===(r=Xe.get(o))||void 0===r?void 0:r.umdMode)||!c(s))){const e=$e.get(o);if(e){const n=e.get(t);(null==n?void 0:n.size)&&n.has(s)&&n.delete(s)}}n.call(e,t,s,i)}}const Ke=["unmount","appstate-change"];function je(e,t){return Ke.includes(e)?`${e}-${t.__MICRO_APP_NAME__}`:e}const Ge=["System","__cjsWrapper"],Ve=["location"],qe=["window","self","globalThis"];class ze{constructor(e,t){this.scopeProperties=["webpackJsonp","Vue"],this.escapeProperties=[],this.injectedKeys=new Set,this.escapeKeys=new Set,this.active=!1,this.microAppWindow={},this.getSpecialProperties(e),this.proxyWindow=this.createProxyWindow(e),this.initMicroAppWindow(this.microAppWindow,e,t),Object.assign(this,function(e){const t=e.__MICRO_APP_NAME__,n=new Map,s=new Map,i=new Map,{rawWindow:r,rawDocument:o,rawWindowAddEventListener:a,rawWindowRemoveEventListener:c,rawSetInterval:l,rawSetTimeout:h,rawClearInterval:u,rawClearTimeout:p,rawDocumentRemoveEventListener:d}=be;e.addEventListener=function(t,s,i){t=je(t,e);const o=n.get(t);o?o.add(s):n.set(t,new Set([s])),s&&(s.__MICRO_APP_MARK_OPTIONS__=i),a.call(r,t,s,i)},e.removeEventListener=function(t,s,i){t=je(t,e);const o=n.get(t);(null==o?void 0:o.size)&&o.has(s)&&o.delete(s),c.call(r,t,s,i)},e.setInterval=function(e,t,...n){const i=l.call(r,e,t,...n);return s.set(i,{handler:e,timeout:t,args:n}),i},e.setTimeout=function(e,t,...n){const s=h.call(r,e,t,...n);return i.set(s,{handler:e,timeout:t,args:n}),s},e.clearInterval=function(e){s.delete(e),u.call(r,e)},e.clearTimeout=function(e){i.delete(e),p.call(r,e)};const m=new Map,f=new Map;let _,A=new Map,b=new Map;return{recordUmdEffect:()=>{n.forEach(((e,t)=>{e.size&&m.set(t,new Set(e))})),s.size&&(A=new Map(s)),i.size&&(b=new Map(i)),_=Fe.get(t);const e=$e.get(t);e&&e.forEach(((e,t)=>{e.size&&f.set(t,new Set(e))}))},rebuildUmdEffect:()=>{m.forEach(((t,n)=>{for(const s of t)e.addEventListener(n,s,null==s?void 0:s.__MICRO_APP_MARK_OPTIONS__)})),A.forEach((t=>{e.setInterval(t.handler,t.timeout,...t.args)})),b.forEach((t=>{e.setTimeout(t.handler,t.timeout,...t.args)})),_&&Fe.set(t,_),v(t),f.forEach(((e,t)=>{for(const n of e)document.addEventListener(t,n,null==n?void 0:n.__MICRO_APP_MARK_OPTIONS__)})),v(null)},releaseEffect:()=>{n.size&&(n.forEach(((e,t)=>{for(const n of e)c.call(r,t,n)})),n.clear()),s.size&&(s.forEach(((e,t)=>{u.call(r,t)})),s.clear()),i.size&&(i.forEach(((e,t)=>{p.call(r,t)})),i.clear()),Fe.delete(t);const e=$e.get(t);e&&(e.forEach(((e,t)=>{for(const n of e)d.call(o,t,n)})),e.clear())}}}(this.microAppWindow))}start(e){this.active||(this.active=!0,this.microAppWindow.__MICRO_APP_BASE_ROUTE__=this.microAppWindow.__MICRO_APP_BASE_URL__=e,be.rawWindow._babelPolyfill&&(be.rawWindow._babelPolyfill=!1),1==++ze.activeCount&&(He(),he()))}stop(e){this.active&&(this.active=!1,this.releaseEffect(),this.microAppWindow.microApp.clearDataListener(),this.microAppWindow.microApp.clearGlobalDataListener(),e||(this.injectedKeys.forEach((e=>{Reflect.deleteProperty(this.microAppWindow,e)})),this.injectedKeys.clear(),this.escapeKeys.forEach((e=>{Reflect.deleteProperty(be.rawWindow,e)})),this.escapeKeys.clear()),0==--ze.activeCount&&(document.addEventListener=be.rawDocumentAddEventListener,document.removeEventListener=be.rawDocumentRemoveEventListener,de()))}
// record umd snapshot before the first execution of umdHookMount
recordUmdSnapshot(){this.microAppWindow.__MICRO_APP_UMD_MODE__=!0,this.recordUmdEffect(),function(e){const t=e.appName;e.umdDataListeners={global:new Set,normal:new Set};const n=Ue.eventList.get("global");if(n)for(const i of n.callbacks)t===i.__APP_NAME__&&e.umdDataListeners.global.add(i);const s=Ue.eventList.get(xe(t,!0));s&&(e.umdDataListeners.normal=new Set(s.callbacks))}(this.microAppWindow.microApp),this.recordUmdInjectedValues=new Map,this.injectedKeys.forEach((e=>{this.recordUmdInjectedValues.set(e,Reflect.get(this.microAppWindow,e))}))}
// rebuild umd snapshot before remount umd app
rebuildUmdSnapshot(){this.recordUmdInjectedValues.forEach(((e,t)=>{Reflect.set(this.proxyWindow,t,e)})),this.rebuildUmdEffect(),function(e){for(const t of e.umdDataListeners.global)e.addGlobalDataListener(t,t.__AUTO_TRIGGER__);for(const t of e.umdDataListeners.normal)e.addDataListener(t,t.__AUTO_TRIGGER__)}(this.microAppWindow.microApp)}
/**
   * get scopeProperties and escapeProperties from plugins
   * @param appName app name
   */getSpecialProperties(e){var t;o(nt.plugins)&&(this.commonActionForSpecialProperties(nt.plugins.global),this.commonActionForSpecialProperties(null===(t=nt.plugins.modules)||void 0===t?void 0:t[e]))}
// common action for global plugins and module plugins
commonActionForSpecialProperties(e){if(r(e))for(const t of e)o(t)&&(r(t.scopeProperties)&&(this.scopeProperties=this.scopeProperties.concat(t.scopeProperties)),r(t.escapeProperties)&&(this.escapeProperties=this.escapeProperties.concat(t.escapeProperties)))}
// create proxyWindow with Proxy(microAppWindow)
createProxyWindow(e){const t=be.rawWindow,s=new Map;return new Proxy(this.microAppWindow,{get:(s,r)=>{if(N(e),Reflect.has(s,r)||n(r)&&/^__MICRO_APP_/.test(r)||this.scopeProperties.includes(r))return Reflect.get(s,r);const o=Reflect.get(t,r);return i(o)?We(t,o):o},set:(e,n,s)=>{if(this.active){if(Ve.includes(n))Reflect.set(t,n,s);else if(
// target.hasOwnProperty has been rewritten
u.call(e,n)||!u.call(t,n)||this.scopeProperties.includes(n))Reflect.set(e,n,s),this.injectedKeys.add(n);else{const i=Object.getOwnPropertyDescriptor(t,n),{configurable:r,enumerable:o,writable:a,set:c}=i;l(e,n,{value:s,configurable:r,enumerable:o,writable:null!=a?a:!!c}),this.injectedKeys.add(n)}(this.escapeProperties.includes(n)||Ge.includes(n)&&!Reflect.has(t,n))&&!this.scopeProperties.includes(n)&&(Reflect.set(t,n,s),this.escapeKeys.add(n))}return!0},has:(e,n)=>this.scopeProperties.includes(n)?n in e:n in e||n in t,
// Object.getOwnPropertyDescriptor(window, key)
getOwnPropertyDescriptor:(e,n)=>{if(u.call(e,n))return s.set(n,"target"),Object.getOwnPropertyDescriptor(e,n);if(u.call(t,n)){s.set(n,"rawWindow");const e=Object.getOwnPropertyDescriptor(t,n);return e&&!e.configurable&&(e.configurable=!0),e}},
// Object.defineProperty(window, key, Descriptor)
defineProperty:(e,n,i)=>"rawWindow"===s.get(n)?Reflect.defineProperty(t,n,i):Reflect.defineProperty(e,n,i),
// Object.getOwnPropertyNames(window)
ownKeys:e=>Reflect.ownKeys(t).concat(Reflect.ownKeys(e)).filter((function(e){return!(e in this)&&(this[e]=!0)}),Object.create(null)),deleteProperty:(e,n)=>!u.call(e,n)||(this.injectedKeys.has(n)&&this.injectedKeys.delete(n),this.escapeKeys.has(n)&&Reflect.deleteProperty(t,n),Reflect.deleteProperty(e,n))})}
/**
   * inject global properties to microAppWindow
   * @param microAppWindow micro window
   * @param appName app name
   * @param url app url
   */initMicroAppWindow(e,t,n){e.__MICRO_APP_ENVIRONMENT__=!0,e.__MICRO_APP_NAME__=t,e.__MICRO_APP_PUBLIC_PATH__=b(n),e.__MICRO_APP_WINDOW__=e,e.microApp=Object.assign(new ke(t),{removeDomScope:R,pureCreateElement:D}),e.rawWindow=be.rawWindow,e.rawDocument=be.rawDocument,e.hasOwnProperty=t=>u.call(e,t)||u.call(be.rawWindow,t),this.setMappingPropertiesWithRawDescriptor(e),this.setHijackProperties(e,t)}
// properties associated with the native window
setMappingPropertiesWithRawDescriptor(e){let t,n;const s=be.rawWindow;s===s.parent?t=n=this.proxyWindow:(t=s.top,n=s.parent),l(e,"top",this.createDescriptorForMicroAppWindow("top",t)),l(e,"parent",this.createDescriptorForMicroAppWindow("parent",n)),qe.forEach((t=>{l(e,t,this.createDescriptorForMicroAppWindow(t,this.proxyWindow))}))}createDescriptorForMicroAppWindow(e,t){const{configurable:n=!0,enumerable:s=!0,writable:i,set:r}=Object.getOwnPropertyDescriptor(be.rawWindow,e)||{writable:!0};return{value:t,configurable:n,enumerable:s,writable:null!=i?i:!!r}}
// set hijack Properties to microAppWindow
setHijackProperties(e,t){let n,s;h(e,{document:{get:()=>(N(t),be.rawDocument),configurable:!1,enumerable:!0},eval:{get:()=>(N(t),n||eval),set:e=>{n=e},configurable:!0,enumerable:!1},Image:{get:()=>(N(t),s||be.ImageProxy),set:e=>{s=e},configurable:!0,enumerable:!1}})}}function Qe(e,t,n,s){var r;if(!e)return p(`element does not exist in lifecycle ${n}`,t);e=S(e),R();const o=Object.assign({name:t,container:e},s&&{error:s}),a=new CustomEvent(n,{detail:o});!function(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},target:{get:()=>t}})}(a,e),i(null===(r=nt.lifeCycles)||void 0===r?void 0:r[n])&&nt.lifeCycles[n](a),e.dispatchEvent(a)}function Je(e,t,n={}){const s=new CustomEvent(`${e}-${t}`,{detail:n});window.dispatchEvent(s)}ze.activeCount=0;const Xe=new Map;class Ye{constructor({name:e,url:t,ssrUrl:n,container:s,inline:i,scopecss:r,useSandbox:o,baseroute:a}){this.state=T.NOT_LOADED,this.keepAliveState=null,this.keepAliveContainer=null,this.loadSourceLevel=0,this.umdHookMount=null,this.umdHookUnmount=null,this.libraryName=null,this.umdMode=!1,this.isPrefetch=!1,this.prefetchResolve=null,this.container=null,this.baseroute="",this.sandBox=null,this.container=null!=s?s:null,this.inline=null!=i&&i,this.baseroute=null!=a?a:"",this.ssrUrl=null!=n?n:"",this.name=e,this.url=t,this.useSandbox=o,this.scopecss=this.useSandbox&&r,this.source={links:new Map,scripts:new Map},this.loadSourceCode(),this.useSandbox&&(this.sandBox=new ze(e,t))}
// Load resources
loadSourceCode(){this.state=T.LOADING_SOURCE_CODE,j.getInstance().run(this,Ie)}
/**
   * When resource is loaded, mount app if it is not prefetch or unmount
   */onLoad(e){var t;2==++this.loadSourceLevel&&(this.source.html=e,this.isPrefetch?(null===(t=this.prefetchResolve)||void 0===t||t.call(this),this.prefetchResolve=null):T.UNMOUNT!==this.state&&(this.state=T.LOAD_SOURCE_FINISHED,this.mount()))}
/**
   * Error loading HTML
   * @param e Error
   */onLoadError(e){this.loadSourceLevel=-1,this.prefetchResolve&&(this.prefetchResolve(),this.prefetchResolve=null),T.UNMOUNT!==this.state&&(this.onerror(e),this.state=T.LOAD_SOURCE_ERROR)}
/**
   * mount app
   * @param container app container
   * @param inline js runs in inline mode
   * @param baseroute route prefix, default is ''
   */mount(e,t,n){var r,o,a;if(s(t)&&t!==this.inline&&(this.inline=t),this.container=null!==(r=this.container)&&void 0!==r?r:e,this.baseroute=null!=n?n:this.baseroute,2!==this.loadSourceLevel)return void(this.state=T.LOADING_SOURCE_CODE);let c;if(Qe(this.container,this.name,W.BEFOREMOUNT),this.state=T.MOUNTING,M(this.source.html,this.container,!this.umdMode),null===(o=this.sandBox)||void 0===o||o.start(this.baseroute),this.umdMode){null===(a=this.sandBox)||void 0===a||a.rebuildUmdSnapshot();try{c=this.umdHookMount()}catch(l){p("an error occurred in the mount function \n",this.name)}this.handleMounted(c)}else{let e=!1;!function(e,t,n){const s=Array.from(e.entries()),i=[],r=[];for(const[o,a]of s)a.isDynamic||(a.defer||a.async?(a.isExternal&&!a.code?i.push(K(o,t.name)):i.push(a.code),r.push([o,a]),a.module&&(n.moduleCount=n.moduleCount?++n.moduleCount:1)):(Re(o,t,a,!1),n(!1)));i.length?w(i,(e=>{const t=r[e.index][1];t.code=t.code||e.data}),(e=>{n.errorCount=n.errorCount?++n.errorCount:1,p(e,t.name)}),(()=>{r.forEach((([e,s])=>{s.code&&(Re(e,t,s,!1,n),!s.module&&n(!1))})),n(void 0===n.moduleCount||n.errorCount===i.length)})):n(!0)}(this.source.scripts,this,(t=>{var n;if(!this.umdMode){const{mount:e,unmount:t}=this.getUmdLibraryHooks();if(i(e)&&i(t)){this.umdHookMount=e,this.umdHookUnmount=t,this.umdMode=!0,null===(n=this.sandBox)||void 0===n||n.recordUmdSnapshot();try{c=this.umdHookMount()}catch(l){p("an error occurred in the mount function \n",this.name)}}}e||!0!==t&&!this.umdMode||(e=!0,this.handleMounted(c))}))}}
/**
   * handle for promise umdHookMount
   * @param umdHookMountResult result of umdHookMount
   */handleMounted(e){a(e)?e.then((()=>this.dispatchMountedEvent())).catch((e=>this.onerror(e))):this.dispatchMountedEvent()}
/**
   * dispatch mounted event when app run finished
   */dispatchMountedEvent(){T.UNMOUNT!==this.state&&(this.state=T.MOUNTED,Qe(this.container,this.name,W.MOUNTED))}
/**
   * unmount app
   * @param destroy completely destroy, delete cache resources
   * @param unmountcb callback of unmount
   */unmount(e,t){let n;if(this.state===T.LOAD_SOURCE_ERROR&&(e=!0),this.state=T.UNMOUNT,this.keepAliveState=null,this.keepAliveContainer=null,this.umdHookUnmount)try{n=this.umdHookUnmount()}catch(s){p("an error occurred in the unmount function \n",this.name)}Je("unmount",this.name),this.handleUnmounted(e,n,t)}
/**
   * handle for promise umdHookUnmount
   * @param destroy completely destroy, delete cache resources
   * @param umdHookUnmountResult result of umdHookUnmount
   * @param unmountcb callback of unmount
   */handleUnmounted(e,t,n){a(t)?t.then((()=>this.actionsForUnmount(e,n))).catch((()=>this.actionsForUnmount(e,n))):this.actionsForUnmount(e,n)}
/**
   * actions for unmount app
   * @param destroy completely destroy, delete cache resources
   * @param unmountcb callback of unmount
   */actionsForUnmount(e,t){var n;e?this.actionsForCompletelyDestroy():this.umdMode&&this.container.childElementCount&&M(this.container,this.source.html,!1),null===(n=this.sandBox)||void 0===n||n.stop(this.umdMode),function(e){const t=[];return Xe.forEach(((n,s)=>{T.UNMOUNT===n.getAppState()||n.isPrefetch||e&&B.KEEP_ALIVE_HIDDEN===n.getKeepAliveState()||t.push(s)})),t}().length||(pe=!1,Element.prototype.setAttribute=be.rawSetAttribute),Qe(this.container,this.name,W.UNMOUNT),this.container.innerHTML="",this.container=null,t&&t()}
// actions for completely destroy
actionsForCompletelyDestroy(){!this.useSandbox&&this.umdMode&&delete window[this.libraryName],Xe.delete(this.name)}
// hidden app when disconnectedCallback called with keep-alive
hiddenKeepAliveApp(){const e=this.container;M(this.container,this.keepAliveContainer?this.keepAliveContainer:this.keepAliveContainer=document.createElement("div"),!1),this.container=this.keepAliveContainer,this.keepAliveState=B.KEEP_ALIVE_HIDDEN,Je("appstate-change",this.name,{appState:"afterhidden"}),Qe(e,this.name,W.AFTERHIDDEN)}
// show app when connectedCallback called with keep-alive
showKeepAliveApp(e){Je("appstate-change",this.name,{appState:"beforeshow"}),Qe(e,this.name,W.BEFORESHOW),M(this.container,e,!1),this.container=e,this.keepAliveState=B.KEEP_ALIVE_SHOW,Je("appstate-change",this.name,{appState:"aftershow"}),Qe(this.container,this.name,W.AFTERSHOW)}
/**
   * app rendering error
   * @param e Error
   */onerror(e){Qe(this.container,this.name,W.ERROR,e)}
// get app state
getAppState(){return this.state}
// get keep-alive state
getKeepAliveState(){return this.keepAliveState}
// get umd library, if it not exist, return empty object
getUmdLibraryHooks(){var e,t;if(T.UNMOUNT!==this.state){const n=null!==(t=null===(e=this.sandBox)||void 0===e?void 0:e.proxyWindow)&&void 0!==t?t:be.rawWindow;return this.libraryName=S(this.container).getAttribute("library")||`micro-app-${this.name}`,"object"==typeof n[this.libraryName]?n[this.libraryName]:{}}return{}}}function Ze(e){class t extends HTMLElement{constructor(){super(),this.isWaiting=!1,this.cacheData=null,this.hasConnected=!1,this.appName="",this.appUrl="",this.ssrUrl="",this.version="0.8.10",this.handleAttributeUpdate=()=>{this.isWaiting=!1;const e=A(this.getAttribute("name")),t=_(this.getAttribute("url"),this.appName);if(this.legalAttribute("name",e)&&this.legalAttribute("url",t)){const n=Xe.get(e);if(e!==this.appName&&n&&T.UNMOUNT!==n.getAppState()&&B.KEEP_ALIVE_HIDDEN!==n.getKeepAliveState()&&!n.isPrefetch)return this.setAttribute("name",this.appName),p(`app name conflict, an app named ${e} is running`,this.appName);e===this.appName&&t===this.appUrl||(e===this.appName?this.handleUnmount(!0,(()=>{this.actionsForAttributeChange(e,t,n)})):this.getKeepAliveModeResult()?(this.handleHiddenKeepAliveApp(),this.actionsForAttributeChange(e,t,n)):this.handleUnmount(this.getDestroyCompatibleResult(),(()=>{this.actionsForAttributeChange(e,t,n)})))}else e!==this.appName&&this.setAttribute("name",this.appName)},pe||(pe=!0,Element.prototype.setAttribute=function(e,t){if(/^micro-app(-\S+)?/i.test(this.tagName)&&"data"===e)if(o(t)){const e={};Object.getOwnPropertyNames(t).forEach((s=>{n(s)&&0===s.indexOf("__")||(e[s]=t[s])})),this.data=e}else"[object Object]"!==t&&d("property data must be an object",this.getAttribute("name"));else if((("src"===e||"srcset"===e)&&/^(img|script)$/i.test(this.tagName)||"href"===e&&/^link$/i.test(this.tagName))&&this.__MICRO_APP_NAME__&&Xe.has(this.__MICRO_APP_NAME__)){const n=Xe.get(this.__MICRO_APP_NAME__);be.rawSetAttribute.call(this,e,g(t,n.url))}else be.rawSetAttribute.call(this,e,t)})}static get observedAttributes(){return["name","url"]}
//  Configuration
// name: app name
// url: html address
// shadowDom: use shadowDOM, default is false
// destroy: whether delete cache resources when unmount, default is false
// inline: whether js runs in inline script mode, default is false
// disableScopecss: whether disable css scoped, default is false
// disableSandbox: whether disable sandbox, default is false
// baseRoute: route prefix, default is ''
// keep-alive: open keep-alive mode
connectedCallback(){this.hasConnected=!0,m((()=>Qe(this,this.appName,W.CREATED))),this.initialMount()}disconnectedCallback(){this.hasConnected=!1,this.getKeepAliveModeResult()?this.handleHiddenKeepAliveApp():this.handleUnmount(this.getDestroyCompatibleResult())}attributeChangedCallback(e,t,n){if(this.legalAttribute(e,n)&&this[e===x.NAME?"appName":"appUrl"]!==n)if(e!==x.URL||this.appUrl)if(e!==x.NAME||this.appName)this.isWaiting||(this.isWaiting=!0,m(this.handleAttributeUpdate));else{const e=A(n);if(!e)return p(`Invalid attribute name ${n}`,this.appName);this.cacheData&&(nt.setData(e,this.cacheData),this.cacheData=null),this.appName=e,e!==n&&this.setAttribute("name",this.appName),this.handleInitialNameAndUrl()}else{if(!(n=_(n,this.appName)))return p(`Invalid attribute url ${n}`,this.appName);this.appUrl=n,this.handleInitialNameAndUrl()}}
// handle for connectedCallback run before attributeChangedCallback
handleInitialNameAndUrl(){this.hasConnected&&this.initialMount()}
/**
     * first mount of this app
     */initialMount(){if(this.appName&&this.appUrl)if(this.getDisposeResult("shadowDOM")&&!this.shadowRoot&&i(this.attachShadow)&&this.attachShadow({mode:"open"}),this.getDisposeResult("ssr")?this.ssrUrl=g(be.rawWindow.location.pathname,this.appUrl):this.ssrUrl&&(this.ssrUrl=""),Xe.has(this.appName)){const e=Xe.get(this.appName),t=e.ssrUrl||e.url,n=this.ssrUrl||this.appUrl;e.getKeepAliveState()===B.KEEP_ALIVE_HIDDEN&&e.url===this.appUrl?this.handleShowKeepAliveApp(e):t!==n||!e.isPrefetch&&e.getAppState()!==T.UNMOUNT?e.isPrefetch||e.getAppState()===T.UNMOUNT?(d(`the ${e.isPrefetch?"prefetch":"unmounted"} app with url: ${t} is replaced by a new app`,this.appName),this.handleCreateApp()):p(`app name conflict, an app named ${this.appName} is running`,this.appName):this.handleAppMount(e)}else this.handleCreateApp()}
// remount app or create app if attribute url or name change
actionsForAttributeChange(e,t,n){var s;this.getDisposeResult("ssr")?this.ssrUrl=g(be.rawWindow.location.pathname,t):this.ssrUrl&&(this.ssrUrl=""),this.appName=e,this.appUrl=t,(null!==(s=this.shadowRoot)&&void 0!==s?s:this).innerHTML="",e!==this.getAttribute("name")&&this.setAttribute("name",this.appName),n?n.getKeepAliveState()===B.KEEP_ALIVE_HIDDEN?n.url===this.appUrl?this.handleShowKeepAliveApp(n):p(`app name conflict, an app named ${this.appName} is running`,this.appName):n.url===this.appUrl&&n.ssrUrl===this.ssrUrl?this.handleAppMount(n):this.handleCreateApp():this.handleCreateApp()}
/**
     * judge the attribute is legal
     * @param name attribute name
     * @param val attribute value
     */legalAttribute(e,t){return!(!n(t)||!t)||(p(`unexpected attribute ${e}, please check again`,this.appName),!1)}
/**
     * mount app
     * some serious note before mount:
     * 1. is prefetch ?
     * 2. is remount in another container ?
     * 3. is remount with change properties of the container ?
     */handleAppMount(e){e.isPrefetch=!1,m((()=>{var t;return e.mount(null!==(t=this.shadowRoot)&&void 0!==t?t:this,this.getDisposeResult("inline"),this.getBaseRouteCompatible())}))}
// create app instance
handleCreateApp(){var e;Xe.has(this.appName)&&Xe.get(this.appName).actionsForCompletelyDestroy();const t=new Ye({name:this.appName,url:this.appUrl,ssrUrl:this.ssrUrl,container:null!==(e=this.shadowRoot)&&void 0!==e?e:this,inline:this.getDisposeResult("inline"),scopecss:!(this.getDisposeResult("disableScopecss")||this.getDisposeResult("shadowDOM")),useSandbox:!this.getDisposeResult("disableSandbox"),baseroute:this.getBaseRouteCompatible()});Xe.set(this.appName,t)}
/**
     * unmount app
     * @param destroy delete cache resources when unmount
     */handleUnmount(e,t){const n=Xe.get(this.appName);n&&n.getAppState()!==T.UNMOUNT&&n.unmount(e,t)}
// hidden app when disconnectedCallback called with keep-alive
handleHiddenKeepAliveApp(){const e=Xe.get(this.appName);e&&e.getAppState()!==T.UNMOUNT&&e.getKeepAliveState()!==B.KEEP_ALIVE_HIDDEN&&e.hiddenKeepAliveApp()}
// show app when connectedCallback called with keep-alive
handleShowKeepAliveApp(e){m((()=>{var t;return e.showKeepAliveApp(null!==(t=this.shadowRoot)&&void 0!==t?t:this)}))}
/**
     * Get configuration
     * Global setting is lowest priority
     * @param name Configuration item name
     */getDisposeResult(e){return(this.compatibleSpecialProperties(e)||nt[e])&&this.compatibleDisableSpecialProperties(e)}
// compatible of disableScopecss & disableSandbox
compatibleSpecialProperties(e){return"disableScopecss"===e?this.hasAttribute("disableScopecss")||this.hasAttribute("disable-scopecss"):"disableSandbox"===e?this.hasAttribute("disableSandbox")||this.hasAttribute("disable-sandbox"):this.hasAttribute(e)}
// compatible of disableScopecss & disableSandbox
compatibleDisableSpecialProperties(e){return"disableScopecss"===e?"false"!==this.getAttribute("disableScopecss")&&"false"!==this.getAttribute("disable-scopecss"):"disableSandbox"===e?"false"!==this.getAttribute("disableSandbox")&&"false"!==this.getAttribute("disable-sandbox"):"false"!==this.getAttribute(e)}
/**
     * 2021-09-08
     * get baseRoute
     * getAttribute('baseurl') is compatible writing of versions below 0.3.1
     */getBaseRouteCompatible(){var e,t;return null!==(t=null!==(e=this.getAttribute("baseroute"))&&void 0!==e?e:this.getAttribute("baseurl"))&&void 0!==t?t:""}
// compatible of destroy
getDestroyCompatibleResult(){return this.getDisposeResult("destroy")||this.getDisposeResult("destory")}
/**
     * destroy has priority over destroy keep-alive
     */getKeepAliveModeResult(){return this.getDisposeResult("keep-alive")&&!this.getDestroyCompatibleResult()}
/**
     * Data from the base application
     */set data(e){this.appName?nt.setData(this.appName,e):this.cacheData=e}
/**
     * get data only used in jsx-custom-event once
     */get data(){return this.appName?nt.getData(this.appName,!0):this.cacheData?this.cacheData:null}}window.customElements.define(e,t)}function et(t){if(!e)return p("preFetch is only supported in browser environment");y((()=>{i(t)&&(t=t()),r(t)&&t.reduce(((e,t)=>e.then((()=>{return e=t,new Promise((t=>{y((()=>{var n,s;if(o(e)&&navigator.onLine)if(e.name=A(e.name),e.url=_(e.url,e.name),e.name&&e.url&&!Xe.has(e.name)){const i=new Ye({name:e.name,url:e.url,scopecss:!(null!==(n=e.disableScopecss)&&void 0!==n?n:nt.disableScopecss),useSandbox:!(null!==(s=e.disableSandbox)&&void 0!==s?s:nt.disableSandbox)});i.isPrefetch=!0,i.prefetchResolve=t,Xe.set(e.name,i)}else t();else t()}))}));var e}))),Promise.resolve())}))}function tt(e,t,s){if(r(e)){const i=e.filter((e=>n(e)&&e.includes(`.${t}`)&&!s.has(e)));w(i.map((e=>K(e))),(e=>{const t=i[e.index];s.has(t)||s.set(t,e.data)}),(e=>{p(e)}))}}var nt=new class extends Te{constructor(){super(...arguments),this.tagName="micro-app",this.preFetch=et}start(t){if(!e||!window.customElements)return p("micro-app is not supported in this environment");if(null==t?void 0:t.tagName){if(!/^micro-app(-\S+)?/.test(t.tagName))return p(`${t.tagName} is invalid tagName`);this.tagName=t.tagName}if(window.customElements.get(this.tagName))return d(`element ${this.tagName} is already defined`);if(ge(),t&&o(t)&&(this.shadowDOM=t.shadowDOM,this.destroy=t.destroy,this.destory=t.destory,this.inline=t.inline,this.disableScopecss=t.disableScopecss,this.disableSandbox=t.disableSandbox,this.ssr=t.ssr,i(t.fetch)&&(this.fetch=t.fetch),o(t.lifeCycles)&&(this.lifeCycles=t.lifeCycles),t.preFetchApps&&et(t.preFetchApps),t.globalAssets&&(o(n=t.globalAssets)&&y((()=>{tt(n.js,"js",we),tt(n.css,"css",te)}))),i(t.excludeAssetFilter)&&(this.excludeAssetFilter=t.excludeAssetFilter),o(t.plugins))){const e=t.plugins.modules;if(o(e))for(const t in e){const n=A(t);n&&t!==n&&(e[n]=e[t],delete e[t])}this.plugins=t.plugins}var n;Ze(this.tagName)}};export{nt as m};
